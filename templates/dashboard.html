{% extends "base.html" %}

{% block page_subtitle %}üìä Sales Dashboard{% endblock %}

{% block content %}
<!-- Action Bar -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h3 style="font-size: 1.125rem; color: var(--text-secondary); font-weight: 500; margin-bottom: 4px;">
            Welcome back! üëã
        </h3>
        <p style="color: var(--text-tertiary); font-size: 0.875rem;">
            Here's your sales performance overview
        </p>
    </div>
    <a href="{{ url_for('leads.add_lead') }}" class="btn btn-primary" style="gap: 8px;">
        <span>‚ûï</span> Add New Lead
    </a>
</div>

<!-- Stats Overview -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_leads }}</div>
        <div class="stat-label">Total Leads</div>
    </div>
    <div class="stat-card high-priority">
        <div class="stat-value">{{ high_priority }}</div>
        <div class="stat-label">üî• High Priority</div>
    </div>
    <div class="stat-card medium-priority">
        <div class="stat-value">{{ medium_priority }}</div>
        <div class="stat-label">‚ö° Medium Priority</div>
    </div>
    <div class="stat-card low-priority">
        <div class="stat-value">{{ low_priority }}</div>
        <div class="stat-label">üìâ Low Priority</div>
    </div>
</div>

<!-- Quick Actions -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <a href="{{ url_for('leads.add_lead') }}" class="action-card" style="text-decoration: none; padding: 20px; background: var(--bg-color); border: 2px solid #3b82f6; border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px;">
        <span style="font-size: 2rem;">‚ûï</span>
        <span style="font-weight: 600; color: var(--text-primary);">Add Lead</span>
        <span style="font-size: 0.75rem; color: var(--text-secondary);">Create new prospect</span>
    </a>
    <a href="{{ url_for('leads.index') }}" class="action-card" style="text-decoration: none; padding: 20px; background: var(--bg-color); border: 2px solid #22c55e; border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px;">
        <span style="font-size: 2rem;">üë•</span>
        <span style="font-weight: 600; color: var(--text-primary);">View Leads</span>
        <span style="font-size: 0.75rem; color: var(--text-secondary);">Manage all leads</span>
    </a>
    <a href="{{ url_for('notifications.index') }}" class="action-card" style="text-decoration: none; padding: 20px; background: var(--bg-color); border: 2px solid #f59e0b; border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px;">
        <span style="font-size: 2rem;">üîî</span>
        <span style="font-weight: 600; color: var(--text-primary);">Notifications</span>
        <span style="font-size: 0.75rem; color: var(--text-secondary);">Check reminders</span>
    </a>
</div>

<style>
    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    html[data-theme="dark"] .action-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
</style>

<div class="grid-2">
    <!-- Top Priority Leads -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üéØ Top Priority Leads</h2>
            <a href="{{ url_for('leads.index') }}" class="btn btn-secondary btn-sm">View All</a>
        </div>
        
        {% if top_leads %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Lead Name</th>
                        <th>Company</th>
                        <th>Score</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in top_leads[:5] %}
                    <tr>
                        <td>
                            <strong>{{ lead.name }}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">{{ lead.email }}</div>
                        </td>
                        <td>{{ lead.company or '-' }}</td>
                        <td>
                            <span class="score-badge score-{% if lead.ai_score >= 70 %}high{% elif lead.ai_score >= 40 %}medium{% else %}low{% endif %}">
                                {{ lead.ai_score }}
                            </span>
                        </td>
                        <td>
                            <span class="recommendation-action" style="font-size: 0.875rem;">
                                {{ lead.recommended_action or 'Pending' }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p class="empty-state-title">No high priority leads yet</p>
            <p>Add leads to see them here</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Recent Leads -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üÜï Recently Added</h2>
            <a href="{{ url_for('leads.add_lead') }}" class="btn btn-secondary btn-sm">Add Lead</a>
        </div>
        
        {% if recent_leads %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Lead Name</th>
                        <th>Status</th>
                        <th>Added</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in recent_leads[:5] %}
                    <tr>
                        <td>
                            <strong>{{ lead.name }}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">{{ lead.company or 'No company' }}</div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ lead.status }}">
                                {{ lead.status }}
                            </span>
                        </td>
                        <td style="font-size: 0.875rem; color: var(--text-secondary);">
                            {{ lead.created_at.strftime('%b %d') }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <p class="empty-state-title">No leads yet</p>
            <p>Start by adding your first lead</p>
            <a href="{{ url_for('leads.add_lead') }}" class="btn btn-primary btn-sm" style="margin-top: 12px;">Add First Lead</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Status Breakdown -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üìà Lead Status Overview</h2>
    </div>
    
    <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-top: 16px;">
        
        {% for status, count in status_counts.items() %}
        {% set status_color_map = {'new': '#3b82f6', 'qualified': '#22c55e', 'converted': '#9333ea', 'lost': '#ef4444'} %}
        <div style="flex: 1; min-width: 150px; padding: 20px; background: var(--bg-color); border-radius: var(--radius); text-align: center; border: 1px solid var(--border-light);">
            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">{{ count }}</div>
            <div style="text-transform: capitalize; color: var(--text-secondary); font-size: 0.875rem; margin-top: 4px;">{{ status }}</div>
            <div style="margin-top: 10px;">
                <span class="status-badge status-{{ status }}">{{ ((count / total_leads) * 100) if total_leads > 0 else 0 |round|int }}%</span>
            </div>
        </div>
        {% else %}
        <div style="flex: 1; text-align: center; padding: 40px; color: var(--text-secondary);">
            No lead status data available yet
        </div>
        {% endfor %}
    </div>
</div>

<!-- Notifications Section -->
{% if notifications %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üîî Recent Notifications</h2>
        <a href="{{ url_for('notifications.index') }}" class="btn btn-secondary btn-sm">View All</a>
    </div>
    
    {% for notification in notifications[:5] %}
    <div class="notification-item {% if not notification.is_read %}unread{% endif %}" data-id="{{ notification.id }}">
        <div class="notification-icon reminder">
            {% if notification.type == 'reminder' %}‚è∞{% elif notification.type == 'alert' %}‚ö†Ô∏è{% elif notification.type == 'meeting' %}üìÖ{% else %}üîî{% endif %}
        </div>
        <div class="notification-content">
            <div class="notification-title">{{ notification.title }}</div>
            <div class="notification-message">{{ notification.message }}</div>
            <div class="notification-time">{{ notification.created_at.strftime('%b %d, %Y %H:%M') }}</div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- AI Insights Panel -->
<div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe;">
    <div class="card-header">
        <h2 class="card-title">üß† AI Insights & Features</h2>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
        <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--border-light);">
            <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">üéØ Smart Lead Scoring</h4>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                Our AI analyzes source, company size, engagement, budget & timeline to generate accurate conversion probability scores.
            </p>
        </div>
        
        <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--border-light);">
            <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">üìã Action Recommendations</h4>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                Based on lead characteristics, the system suggests the best next action: call, email, schedule meeting, or nurture.
            </p>
        </div>
        
        <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--border-light);">
            <h4 style="color: var(--primary-color); margin-bottom: 8px; font-weight: 600;">üîî Smart Reminders</h4>
            <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                Automated notifications ensure you never miss a follow-up. High-priority leads get reminded daily.
            </p>
        </div>
    </div>
</div>

<!-- Help Assistant Widget -->
<div id="help-widget" class="help-widget" style="display: none;">
    <div class="help-container">
        <div class="help-header">
            <h3>üí° Help & Recommendations</h3>
            <button id="close-help" class="help-close">√ó</button>
        </div>
        <div id="help-messages" class="help-messages"></div>
        <div class="help-input-area">
            <input type="text" id="help-input" placeholder="Ask about: Call, Email, Follow-up, Manage..." class="help-input">
            <button id="send-help" class="help-send">Send</button>
        </div>
    </div>
</div>

<!-- Help Toggle Button -->
<button id="help-toggle" class="help-toggle" title="Open Help & Recommendations">üí°</button>

<style>
    .help-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        transition: all 0.3s ease;
        z-index: 999;
    }
    
    .help-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
    }
    
    .help-widget {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 420px;
        height: 500px;
        max-height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 998;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
        overflow: hidden;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    html[data-theme="dark"] .help-widget {
        background: #1e293b;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    
    .help-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    
    .help-header {
        padding: 16px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .help-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }
    
    .help-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        transition: all 0.2s ease;
    }
    
    .help-close:hover {
        opacity: 0.8;
    }
    
    .help-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--bg-color, #f8fafc);
    }
    
    .help-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .help-messages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    html[data-theme="dark"] .help-messages {
        background: #0f172a;
    }
    
    .help-message {
        display: flex;
        gap: 8px;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .help-message.user {
        justify-content: flex-end;
    }
    
    .help-message-content {
        max-width: 85%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .help-message.bot .help-message-content {
        background: #e2e8f0;
        color: #1e293b;
    }
    
    html[data-theme="dark"] .help-message.bot .help-message-content {
        background: #334155;
        color: #f1f5f9;
    }
    
    .help-message.user .help-message-content {
        background: #f59e0b;
        color: white;
    }
    
    .help-input-area {
        padding: 12px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 8px;
        background: var(--bg-secondary, #f1f5f9);
        flex-shrink: 0;
    }
    
    html[data-theme="dark"] .help-input-area {
        background: #1e293b;
        border-top-color: #334155;
    }
    
    .help-input {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: inherit;
        background: white;
        color: #1e293b;
    }
    
    html[data-theme="dark"] .help-input {
        background: #334155;
        color: #f1f5f9;
        border-color: #475569;
    }
    
    .help-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    
    .help-send {
        padding: 10px 16px;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
        white-space: nowrap;
    }
    
    .help-send:hover {
        background: #d97706;
    }
    
    .help-send:active {
        transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
        .help-widget {
            width: calc(100vw - 40px);
            height: 400px;
            bottom: 90px;
            right: 20px;
        }
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    // Help Assistant
    document.addEventListener('DOMContentLoaded', function() {
        const helpToggle = document.getElementById('help-toggle');
        const helpWidget = document.getElementById('help-widget');
        const closeBtn = document.getElementById('close-help');
        const sendBtn = document.getElementById('send-help');
        const helpInput = document.getElementById('help-input');
        const messagesDiv = document.getElementById('help-messages');
        
        helpToggle.addEventListener('click', () => {
            const isHidden = helpWidget.style.display === 'none' || helpWidget.style.display === '';
            helpWidget.style.display = isHidden ? 'flex' : 'none';
            
            if (isHidden && messagesDiv.children.length === 0) {
                addBotMessage('üëã Hi! Need help? Ask about:\n\nüìû Call\nüìß Email\n‚è∞ Follow-up\nüìã Manage\nüí° Recommendations');
            }
            
            if (isHidden) helpInput.focus();
        });
        
        closeBtn.addEventListener('click', () => {
            helpWidget.style.display = 'none';
        });
        
        sendBtn.addEventListener('click', sendMessage);
        helpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        function addBotMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'help-message bot';
            msgDiv.innerHTML = `<div class="help-message-content">${message}</div>`;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addUserMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'help-message user';
            msgDiv.innerHTML = `<div class="help-message-content">${message}</div>`;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function sendMessage() {
            const message = helpInput.value.trim();
            if (!message) return;
            
            addUserMessage(message);
            helpInput.value = '';
            
            fetch('/help/api/message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            })
            .then(res => res.json())
            .then(data => {
                if (data.bot_response) {
                    addBotMessage(data.bot_response);
                } else {
                    addBotMessage('Sorry, I encountered an error. Please try again!');
                }
            })
            .catch(err => {
                addBotMessage('Sorry, I encountered an error. Please try again!');
            });
        }
    });
    
    // Dashboard specific scripts
    function loadDashboardStats() {
        // Auto-refresh stats every 60 seconds
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        setInterval(loadDashboardStats, 60000);
    });
</script>
{% endblock %}

